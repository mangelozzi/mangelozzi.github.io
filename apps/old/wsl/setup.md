# WSL2

- Follow this guide: <https://docs.microsoft.com/en-us/windows/wsl/install-win10>

## DNS (Cannot resolve host)

Neovim will fail to install packages, so will apt-get update. To fix do the following:

1. Create a file: `/etc/wsl.conf`.
2. Put the following lines in the file
    ```
    [network]
    generateResolvConf = false
    ```
3. `ls -l /etc/resolv.conf`, is a symlinked file which is auto-generated.
4. Copy the contents of `/etc/resolv.conf` to say `etc/resolv.conf.bak`
5. Change `172.24.0.1` to another nameserver, e.g.:
   - Current router: `192.168.0.1`
   - Google: `8.8.8.8`
   Should be something like:
    ```
    # This file was automatically generated by WSL. To stop automatic generation of this file, add the following entry to /etc/wsl.conf:
    # [network]
    # generateResolvConf = false
    nameserver 192.168.0.1
    ```
6. Delete the symlink `rm /etc/resolve.conf`
7. In a `cmd` window, run `wsl --shutdown` or `wsl -t <DISTRIBUTION_NAME>`
8. Restart WSL2


## .BASHRC NOT EXECUTED

To tell windows to start wsl/bash with an interactive shell (i.e. load ~.bashrc)
one can do `bash.exe -i` (now you have colours and should feel more homey).

To have `wsl` or `bash` automatically start an  interactive prompt, create
`~/.profile` and paste inside of it:
```bash
if [ -n "$BASH_VERSION" ]; then
    # include .bashrc if it exists
    if [ -f "$HOME/.bashrc" ]; then
        . "$HOME/.bashrc"
    fi
fi
```

### WSL2 Port forward

CAVEAT! Upon reboot the WSL port changes, and hence one will loose internet
connectivity. So one has to setup the port forward again. The start dev script
runs the below script every time. One can reset the port forward to return
normal behaviour (losing outside WSL access) with:
```
netsh interface portproxy reset
```

#### Manual Setup

1. Start Django running as IP address 0.0.0.0 (means listen on all ports).
    ```
        python manage.py runserver 0.0.0.0:8000
    ```
2. Ensure Django settings ALLOWED hosts, contains `*` or `0.0.0.0`.
3. Get the WSL2 IP4 Address
    1. In Ubuntu I run:
       ```
          sudo apt install net-tools
       ```
    2. Then get the IP4 address with:
       ```
          ifconfig eth0
       ```
    3. Ensure to get the first IP4 address, NOT the second broadcase one
        which ends in `.255`.
4. Setup up windows to forward traffic to WSL2 IP4 Address, e.g. for IP address `172.31.191.138`
    ```
        netsh interface portproxy add v4tov4 listenport=8000 listenaddress=0.0.0.0 connectport=8000 connectaddress=172.31.191.138
    ```
5. Check the rule was successfully created:
    ```
        netsh interface portproxy show v4tov4
    ```
6. One can delete all port forwarding proxy rules with:
    ```
        netsh interface portproxy reset
    ```
7. Then create INBOUND and OUTBOUND firewall rules for the required ports:
    1. `WIN+R` and run `WF.msc`
    2. Top left `Inbound Rules` right click on it and select `New Rule...`
    2. Top left `Outbound Rules` right click on it and select `New Rule...`

8. Restart Computer (check WSL port hasn't changed)

#### Script Setup

Alternatively one can run a script which performs the above:
1. Ensure one has installed `net-tool` as above so `ifconfig` commands works.
2. Run the script (right click and select run): [WSL Port Forward Script](WSL2_Port_Forward.ps1)


## Not systemd (required for snapd)

- Install this: https://github.com/DamionGans/ubuntu-wsl2-systemd-script
